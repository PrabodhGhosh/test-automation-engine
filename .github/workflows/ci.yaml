name: ðŸ§ª SDET CI with Selenium Grid (Docker Services)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build_and_test:
    # Use the OS variable from the strategy matrix
    runs-on: ${{ matrix.os }} 

    strategy:
      # Define combinations to test against (Matrix Build Strategy)
      matrix:
        java-version: [ '11', '17' ] 
        os: [ ubuntu-latest ] 

    # ðŸ‘‡ SELENIUM GRID DOCKER SERVICES SETUP (FIXED)
    services:
      selenium-hub:
        image: selenium/hub:4.20.0 # Selenium Hub
        ports:
          - 4444:4444 # Map container port 4444 to runner port 4444
      chrome-node:
        image: selenium/node-chrome:4.20.0 # Chrome Node
        # ðŸ‘‡ FIX 1: Changed 'environment' to 'env' and updated format
        env:
          SE_EVENT_BUS_HOST: selenium-hub
          SE_EVENT_BUS_PUBLISH_PORT: 4442
          SE_EVENT_BUS_SUBSCRIBE_PORT: 4443
        # ðŸ‘† FIX 2: Removed 'depends-on' as it is not a valid key here.
    # ðŸ‘† END OF SELENIUM GRID SETUP

    steps:
      # Step 1: Clone the repository code
      - name: Checkout Repository Code
        uses: actions/checkout@v4 

      # Step 2: Setup Java Environment with Caching
      - name: Set up JDK ${{ matrix.java-version }} Environment (Cache Maven)
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          # Dependency Caching feature
          cache: 'maven' 

      # Step 3: Run the tests
      - name: Build and Execute Tests
        # CRUCIAL: Pass the Grid URL using the service name 'selenium-hub'
        run: mvn clean verify -Dselenium.url="http://selenium-hub:4444/wd/hub"
        
        # New Debugging Step: Check contents of report directories
      - name: Debug Report Directory Contents
        run: |
          echo "Listing files in surefire reports:"
          ls -R target/surefire-reports/ || echo "surefire-reports directory not found or empty."
          echo "Listing files in failsafe reports:"
          ls -R target/failsafe-reports/ || echo "failsafe-reports directory not found or empty."
          echo "Current working directory:"
          pwd

      # Step 4: Publish Test Results (SDET Practice: Test Reporting)
      - name: Publish JUnit XML Results
        if: always()  
        uses: dorny/test-reporter@v1
        with:
          name: Unit/Integration Test Report
          path: |
            # Target the individual JUnit reports within the subfolder:
            target/surefire-reports/junitreports/*.xml
            # Target the main aggregate JUnit report (optional but safe):
            target/surefire-reports/TEST-TestSuite.xml
          reporter: java-junit

      # Step 5: Upload Artifacts (SDET Practice: Artifact Upload)
      - name: Upload Failure Artifacts
        if: failure() 
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-logs-and-assets
          path: |
            target/logs/
            target/screenshots/